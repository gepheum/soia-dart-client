name: Publish to pub.dev

# This workflow publishes the Dart package to pub.dev when a release is created
on:
  release:
    types: [created]

jobs:
  publish:
    name: Publish to pub.dev
    runs-on: ubuntu-latest

    permissions:
      id-token: write # Required for authentication using OIDC

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Dart
      uses: dart-lang/setup-dart@v1
      with:
        sdk: 'stable'

    - name: Install dependencies
      run: dart pub get

    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Analyze project source
      run: dart analyze --fatal-infos

    - name: Run tests
      run: dart test

    # Verify that the package is ready for publishing
    - name: Check publish readiness
      run: dart pub publish --dry-run

    # Publish to pub.dev
    - name: Publish to pub.dev
      run: dart pub publish --force

    # Optional: Create a comment on the release with the pub.dev link
    - name: Comment on release
      uses: actions/github-script@v7
      with:
        script: |
          const packageName = 'soia'; // Update this if your package name changes
          const version = context.payload.release.tag_name.replace(/^v/, '');
          
          github.rest.issues.createComment({
            issue_number: context.payload.release.id,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🎉 Package published successfully to pub.dev!\n\n📦 **View on pub.dev**: https://pub.dev/packages/${packageName}/versions/${version}\n\n📝 **Install**: \`dart pub add ${packageName}:${version}\``
          });
